#!/bin/bash

sudo ./system_backup.sh

# Check if /boot/firmware/config.txt exists
if [ -f "/boot/firmware/config.txt" ]; then
    CONFIG_DIR="/boot/firmware"
else
    CONFIG_DIR="/boot"
fi

CONFIG_PATH="$CONFIG_DIR/config.txt"

# Create a backup of the config file in the same directory
sudo cp -rf "$CONFIG_PATH" "$CONFIG_DIR/config.txt.bak"

sudo cp ./usr/ads7846-overlay.dtb /boot/overlays/ads7846.dtbo

source ./system_config.sh
if [[ "$deb_version" < "12.1" ]]; then
    row=`grep -nr "#dtoverlay=vc4-fkms-v3d" "$CONFIG_DIR/config.txt.bak" | awk -F ':' '{if(NR==1)printf $1}'`
    sudo sed -i -e ''"$row"'s/#dtoverlay=vc4-fkms-v3d/dtoverlay=vc4-fkms-v3d/' "$CONFIG_DIR/config.txt.bak"
    sudo sed -i -e 's/#max_framebuffers=2/max_framebuffers=2/' "$CONFIG_DIR/config.txt.bak"
fi
if [ $hardware_model -eq 5 ]; then
    sudo sed -i -e 's/#dtoverlay=vc4-kms-v3d/dtoverlay=vc4-kms-v3d/' "$CONFIG_DIR/config.txt.bak"
fi

# Add Wayland-specific configurations
sudo echo "dtoverlay=vc4-kms-v3d" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "dtoverlay=drm-vc4-kms-v3d" >> "$CONFIG_DIR/config.txt.bak"

# Add other configurations
sudo echo "hdmi_force_hotplug=1" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "dtparam=i2c_arm=on" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "dtparam=spi=on" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "enable_uart=1" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "display_rotate=0" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "max_usb_current=1" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "config_hdmi_boost=7" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "hdmi_group=2" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "hdmi_mode=1" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "hdmi_mode=87" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "hdmi_drive=1" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "hdmi_cvt 800 480 60 6 0 0 0" >> "$CONFIG_DIR/config.txt.bak"
sudo echo "dtoverlay=ads7846,cs=1,penirq=25,penirq_pull=2,speed=50000,keep_vref_on=0,swapxy=0,pmax=255,xohms=150,xmin=200,xmax=3900,ymin=200,ymax=3900" >> "$CONFIG_DIR/config.txt.bak"

sudo cp -rf "$CONFIG_DIR/config.txt.bak" "$CONFIG_PATH"

sudo cp ./usr/inittab /etc/

# Remove X11-specific configurations
if [ -d /etc/X11/xorg.conf.d ]; then
    sudo rm -rf /etc/X11/xorg.conf.d/*
fi

# Set up Wayland
if [ ! -f /etc/systemd/system/display-manager.service ]; then
    sudo ln -s /lib/systemd/system/weston.service /etc/systemd/system/display-manager.service
fi

# Install Wayland and Weston if not already installed
sudo apt-get update
sudo apt-get install -y wayland weston

sudo touch ./.have_installed
echo "hdmi:resistance:5:0:800:480" > ./.have_installed

version=`uname -v`
version=${version##* }
echo $version

if test $version -ge 2017; then
    echo "Updating touch configuration for Wayland"
    # Install libinput for Wayland touch support
    sudo apt-get install -y libinput-bin
fi

sudo sync
sudo sync
sleep 1

if [ $# -eq 1 ]; then
    sudo ./rotate.sh $1
elif [ $# -gt 1 ]; then
    echo "Too many parameters"
fi

echo "reboot now"
sudo reboot